#!/bin/sh
#
# Build or rebuild the installation (pip packages, Odoo modules).

set -e

# Check if we are in correct folder
. sfoil-check-project

# Load variables
export $(cat ./shared.env | xargs)
if test -e ./local.env; then
    export $(cat ./local.env | xargs)
fi

# Aggregate Odoo module sources
cd custom/src
gitaggregate --expand-env --config=repos.yaml --jobs=4 aggregate
cd ../..

# TODO: run clean step
# TODO: run compileall

# Install Odoo and make link
TMPREQ=$(mktemp)
cat custom/src/odoo/requirements.txt | grep -v pypiwin32 > $TMPREQ
pipenv install -r $TMPREQ
pipenv lock --keep-outdated
pipenv install -e custom/src/odoo

# TODO: run addons-link
# TODO: run config-generate
